<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CSV Upload</title>
</head>
<body>
  <h2>Subir archivo CSV</h2>
  <input type="file" id="csvFile" accept=".csv" />
  <button onclick="handleUpload()">Procesar y Enviar</button>

  <!-- Selector de opciones -->
  <label for="opcion">Seleccioná una opción:</label>
  <select id="opcion">
    <option value="">-- Elegí una opción --</option>
    <option value="1" label = "Escribanos"></option>
    <option value="2" label = "Clientes"></option>
    <option value="3" label = "Escrituras"></option>
    <option value="4" label = "Tipo escrituras"></option>
  </select>

  <br><br>

  <script>
    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(',').map(h => h.trim());
      const data = lines.slice(1).map(line => {
        const values = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((header, i) => {
          obj[header] = values[i];
        });
        return obj;
      });
      return data;
    }

    async function handleUpload() {
      console.log('Llamando handleUpload');
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];
      if (!file) {
        alert('Por favor seleccioná un archivo CSV.');
        return;
      }
        
      const seleccionar = document.getElementById('opcion');
      const opcionSeleccionada = seleccionar.options[seleccionar.selectedIndex];

      const opcion = opcionSeleccionada.label;
      if (opcion == 0) {
        alert('Por favor seleccioná una opción antes de continuar.');
        return;
      }

      const text = await file.text();
      const jsonData = parseCSV(text);
      opcion = opcion.replace(" ", "_");

      const aEnviar = {
        tabla: opcion,   
        data: jsonData 
      };

      try {
        console.log('Llamando al fetch');
        const response = await fetch('../api/csv', {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(aEnviar)
        });

        if (response.ok) {
          alert('Datos enviados correctamente.');
        } else {
          alert('Error al enviar los datos.');
        }
      } catch (error) {
        console.error('Error en la solicitud:', error);
        alert('Error de red o en el servidor.');
      }
    }
  </script>
</body>
</html>
